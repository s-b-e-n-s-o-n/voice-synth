#!/usr/bin/env python3
"""
voice-synth - Interactive TUI for email data preparation pipeline

All dependencies are automatically installed to ~/.cache/voice-synth/venv/
"""

import os
import signal
import subprocess
import sys
import time
from pathlib import Path

VERSION = "0.4.0-alpha"

# Colors (ANSI escape codes - stdlib only, no deps needed)
PURPLE = "\033[38;5;99m"
GREEN = "\033[38;5;82m"
YELLOW = "\033[38;5;214m"
DIM = "\033[38;5;245m"
BOLD = "\033[1m"
RESET = "\033[0m"

# Spinner frames
SPINNER = ["⠋", "⠙", "⠹", "⠸", "⠼", "⠴", "⠦", "⠧", "⠇", "⠏"]

# Paths
CACHE_DIR = Path(os.environ.get("XDG_CACHE_HOME", Path.home() / ".cache")) / "voice-synth"
VENV_DIR = CACHE_DIR / "venv"
PYTHON = VENV_DIR / "bin" / "python3"
SCRIPT_DIR = Path(__file__).resolve().parent


def graceful_exit(signum=None, frame=None):
    """Handle Ctrl+C gracefully."""
    print(f"\n\n  {DIM}Goodbye!{RESET}\n")
    sys.exit(0)


signal.signal(signal.SIGINT, graceful_exit)
signal.signal(signal.SIGTERM, graceful_exit)


def get_terminal_width():
    """Get terminal width, defaulting to 80."""
    try:
        return os.get_terminal_size().columns
    except OSError:
        return 80


def center(text, width=None):
    """Center text in terminal."""
    if width is None:
        width = get_terminal_width()
    lines = text.split("\n")
    return "\n".join(line.center(width) for line in lines)


def print_banner():
    """Print the purple ASCII banner using stdlib only."""
    title = "Voice Synthesizer"
    subtitle = "Email data preparation for GPT fine-tuning"
    version = f"v{VERSION}"

    print()
    print()
    print(center(f"{BOLD}{PURPLE}{title}{RESET}"))
    print(center(f"{DIM}{subtitle}{RESET}"))
    print(center(f"{DIM}{version}{RESET}"))
    print()


def spinner_print(message, done=False, success=True):
    """Print a line with spinner or checkmark."""
    if done:
        mark = f"{GREEN}✓{RESET}" if success else f"{YELLOW}!{RESET}"
        print(f"\r  {mark} {message}                    ")
    else:
        # Just print the message, spinner animation handled separately
        print(f"  {SPINNER[0]} {message}", end="", flush=True)


def run_with_spinner(cmd, message, capture=False):
    """Run a command with a spinner animation."""
    print(f"  {SPINNER[0]} {message}", end="", flush=True)

    proc = subprocess.Popen(
        cmd,
        stdout=subprocess.PIPE if capture else subprocess.DEVNULL,
        stderr=subprocess.PIPE,
        text=True
    )

    frame = 0
    while proc.poll() is None:
        print(f"\r  {PURPLE}{SPINNER[frame % len(SPINNER)]}{RESET} {message}", end="", flush=True)
        frame += 1
        time.sleep(0.1)

    success = proc.returncode == 0
    mark = f"{GREEN}✓{RESET}" if success else f"{YELLOW}!{RESET}"
    print(f"\r  {mark} {message}                    ")

    if capture:
        return proc.stdout.read(), proc.stderr.read(), proc.returncode
    return None, None, proc.returncode


def ensure_venv():
    """Create venv if it doesn't exist."""
    if VENV_DIR.exists() and PYTHON.exists():
        return True

    CACHE_DIR.mkdir(parents=True, exist_ok=True)

    _, _, rc = run_with_spinner(
        [sys.executable, "-m", "venv", str(VENV_DIR)],
        "Creating Python environment"
    )

    if rc != 0:
        print(f"  {YELLOW}!{RESET} Failed to create virtual environment")
        return False

    # Upgrade pip
    run_with_spinner(
        [str(PYTHON), "-m", "pip", "install", "--upgrade", "pip", "--quiet"],
        "Upgrading pip"
    )

    return True


def check_import(module_name):
    """Check if a module can be imported in the venv."""
    result = subprocess.run(
        [str(PYTHON), "-c", f"import {module_name}"],
        capture_output=True
    )
    return result.returncode == 0


def check_spacy_model():
    """Check if spaCy model is installed."""
    result = subprocess.run(
        [str(PYTHON), "-c", "import spacy; spacy.load('en_core_web_lg')"],
        capture_output=True
    )
    return result.returncode == 0


def install_lightweight_deps():
    """Install lightweight dependencies (textual, rich, ijson, datasketch)."""
    packages = []

    if not check_import("textual"):
        packages.append("textual>=1.0.0")
    if not check_import("rich"):
        packages.append("rich>=13.0.0")
    if not check_import("ijson"):
        packages.append("ijson>=3.2.0")
    if not check_import("datasketch"):
        packages.append("datasketch>=1.6.0")

    if not packages:
        return True

    _, _, rc = run_with_spinner(
        [str(PYTHON), "-m", "pip", "install", "--quiet"] + packages,
        f"Installing {', '.join(p.split('>=')[0] for p in packages)}"
    )

    return rc == 0


def install_heavy_deps_with_progress():
    """Install heavy dependencies with Rich progress bars."""
    # Check what we need to install
    need_presidio = not check_import("presidio_analyzer")
    need_spacy = not check_import("spacy")
    need_model = not check_spacy_model()

    if not need_presidio and not need_spacy and not need_model:
        return True

    # Now we can use Rich since lightweight deps are installed
    try:
        from rich.console import Console
        from rich.progress import Progress, SpinnerColumn, TextColumn, BarColumn, TaskProgressColumn
        from rich.panel import Panel
        from rich.text import Text
    except ImportError:
        # Fallback to simple spinners if Rich isn't working
        if need_spacy:
            run_with_spinner(
                [str(PYTHON), "-m", "pip", "install", "spacy>=3.5.0", "--quiet"],
                "Installing spaCy"
            )
        if need_presidio:
            run_with_spinner(
                [str(PYTHON), "-m", "pip", "install", "presidio-analyzer>=2.2.0", "presidio-anonymizer>=2.2.0", "--quiet"],
                "Installing Presidio"
            )
        if need_model:
            run_with_spinner(
                [str(PYTHON), "-m", "spacy", "download", "en_core_web_lg", "--quiet"],
                "Downloading language model (~500MB)"
            )
        return True

    console = Console()

    # Show what we're installing
    console.print()
    console.print(Panel(
        Text.from_markup(
            "[bold #9370DB]Installing Privacy Protection Components[/]\n\n"
            "[dim]These only download once and enable PII anonymization.[/]"
        ),
        border_style="#9370DB"
    ))
    console.print()

    with Progress(
        SpinnerColumn(style="#9370DB"),
        TextColumn("[progress.description]{task.description}"),
        BarColumn(complete_style="#00FF7F", finished_style="#00FF7F"),
        TaskProgressColumn(),
        console=console,
    ) as progress:
        if need_spacy:
            task = progress.add_task("Installing spaCy...", total=None)
            subprocess.run(
                [str(PYTHON), "-m", "pip", "install", "spacy>=3.5.0", "--quiet"],
                capture_output=True
            )
            progress.update(task, completed=True, description="[#00FF7F]✓[/] spaCy installed")

        if need_presidio:
            task = progress.add_task("Installing Presidio...", total=None)
            subprocess.run(
                [str(PYTHON), "-m", "pip", "install",
                 "presidio-analyzer>=2.2.0", "presidio-anonymizer>=2.2.0", "--quiet"],
                capture_output=True
            )
            progress.update(task, completed=True, description="[#00FF7F]✓[/] Presidio installed")

        if need_model:
            task = progress.add_task("Downloading language model (~500MB)...", total=None)
            subprocess.run(
                [str(PYTHON), "-m", "spacy", "download", "en_core_web_lg", "--quiet"],
                capture_output=True
            )
            progress.update(task, completed=True, description="[#00FF7F]✓[/] Language model ready")

    console.print()
    console.print(f"  [#00FF7F]✓[/] [bold]Setup complete![/]")
    console.print()
    time.sleep(0.5)

    return True


def check_all_deps():
    """Check if all dependencies are installed."""
    if not PYTHON.exists():
        return False

    checks = [
        check_import("textual"),
        check_import("rich"),
        check_import("ijson"),
        check_import("datasketch"),
        check_import("presidio_analyzer"),
        check_import("spacy"),
        check_spacy_model(),
    ]

    return all(checks)


def setup_deps():
    """Full dependency setup with phased installation."""
    if check_all_deps():
        return True

    print()
    print(center(f"{PURPLE}{BOLD}First-time setup{RESET}"))
    print()
    print(center(f"{DIM}Installing required components...{RESET}"))
    print(center(f"{DIM}This only happens once.{RESET}"))
    print()

    # Phase 1: Create venv
    if not ensure_venv():
        return False

    # Phase 2: Install lightweight deps (enables Rich for phase 3)
    if not install_lightweight_deps():
        return False

    # Phase 3: Install heavy deps with Rich progress
    if not install_heavy_deps_with_progress():
        return False

    return True


def run_cli_mode(args):
    """Run in CLI passthrough mode - pass args directly to pipeline.py."""
    if not PYTHON.exists():
        # Quick setup for CLI mode
        print("Setting up environment...")
        if not ensure_venv():
            sys.exit(1)

        # Install deps quietly
        subprocess.run(
            [str(PYTHON), "-m", "pip", "install", "--quiet",
             "ijson>=3.2.0", "datasketch>=1.6.0",
             "presidio-analyzer>=2.2.0", "presidio-anonymizer>=2.2.0",
             "spacy>=3.5.0"],
            capture_output=True
        )
        subprocess.run(
            [str(PYTHON), "-m", "spacy", "download", "en_core_web_lg", "--quiet"],
            capture_output=True
        )

    # Run pipeline.py with the provided arguments
    pipeline_path = SCRIPT_DIR / "pipeline.py"
    os.execv(str(PYTHON), [str(PYTHON), str(pipeline_path)] + args)


def run_tui_with_tty():
    """Launch the TUI with stdin from /dev/tty (called as subprocess)."""
    # Clear screen and show banner during setup
    print("\033[2J\033[H", end="")  # Clear screen
    print_banner()

    # Setup dependencies
    if not setup_deps():
        print(f"\n  {YELLOW}!{RESET} Setup failed. Please check your Python installation.")
        sys.exit(1)

    # Run the Textual TUI
    tui_path = SCRIPT_DIR / "tui.py"
    os.execv(str(PYTHON), [str(PYTHON), str(tui_path)])


def run_tui_mode():
    """Run in interactive TUI mode, handling piped stdin."""
    # Check if stdin is piped (e.g., curl | bash)
    if not sys.__stdin__.isatty():
        # Stdin is piped - launch subprocess with /dev/tty
        try:
            with open("/dev/tty", "rb", buffering=0) as tty_stdin:
                # Re-run ourselves with stdin from the TTY
                result = subprocess.run(
                    [sys.executable, str(Path(__file__).resolve()), "--tui-internal"],
                    stdin=tty_stdin,
                    env={**os.environ, "TEXTUAL_ALLOW_SIGNALS": "1"}
                )
                sys.exit(result.returncode)
        except FileNotFoundError:
            print(f"{YELLOW}Error:{RESET} No terminal available for interactive mode.")
            print(f"{DIM}Run './voice-synth' directly from a terminal.{RESET}")
            sys.exit(1)
    else:
        # Normal execution - stdin is a terminal
        run_tui_with_tty()


def main():
    """Entry point."""
    args = sys.argv[1:]

    # Internal flag for subprocess re-execution with TTY
    if args == ["--tui-internal"]:
        run_tui_with_tty()
        return

    # CLI passthrough mode if arguments provided
    if args:
        run_cli_mode(args)
    else:
        # Interactive TUI mode
        run_tui_mode()


if __name__ == "__main__":
    main()
